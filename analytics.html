<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Analytics Data Presentation Widget</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0f1217;
      --card: #161b22;
      --muted: #8b949e;
      --text: #e6edf3;
      --accent: #7c9cff;
      --border: #262b36;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius: 16px;
      --danger: #ff8585;
      --success: #4ade80;
      --warn: #f59e0b;
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--text); }
    a { color: var(--accent); }

    .widget { padding: 24px; max-width: 1200px; margin: 0 auto; }

    .toolbar { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; justify-content: space-between; }
    .btn { background: linear-gradient(180deg, #2a3243, #202738); color: #fff; border: 1px solid var(--border); padding: 10px 14px; border-radius: 12px; cursor: pointer; box-shadow: var(--shadow); font-weight: 600; }
    .btn.secondary { background: #1a2030; }
    .btn.ghost { background: transparent; border-color: var(--border); box-shadow: none; }
    .btn[disabled] { opacity: .6; cursor: not-allowed; }

    .grid { display: grid; gap: 16px; grid-template-columns: 1fr; }
    @media (min-width: 1024px) { .grid { grid-template-columns: 1fr 2fr; } }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; }
    .card-header { padding: 14px 16px; border-bottom: 1px solid var(--border); font-weight: 700; letter-spacing: 0.2px; color: var(--muted); display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .card-body { padding: 16px; }

    .textarea { width: 100%; min-height: 260px; border-radius: 12px; background: #0e1320; color: var(--text); border: 1px solid var(--border); padding: 12px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }

    /* Panels */
    .error-panel { display:none; margin-top: 10px; padding: 10px 12px; border: 1px solid #5f1f28; background: #1a0f12; border-radius: 12px; color: var(--danger); }
    .error-panel pre { white-space: pre-wrap; margin: 6px 0 0; color: #ffb5b5; font-size: 12px; }

    .precheck-panel { display:none; margin-top: 10px; padding: 10px 12px; border: 1px solid var(--border); background: #0f1524; border-radius: 12px; }
    .precheck-panel .title { font-weight: 700; font-size: 13px; margin-bottom: 6px; }
    .precheck-panel .ok { color: var(--success); }
    .precheck-panel .warn { color: var(--warn); }
    .precheck-panel .err { color: var(--danger); }
    .precheck-panel ul { margin: 6px 0; padding-left: 18px; font-size: 12px; }

    /* Progress */
    .progress { display:none; position: relative; height: 12px; background: #0f1524; border: 1px solid var(--border); border-radius: 999px; overflow: hidden; }
    .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #5b8aff, #7c9cff); transition: width .2s ease; }
    .progress-row { display:flex; align-items:center; gap:10px; margin: 8px 0 0; }
    .progress-label { font-size: 12px; color: var(--muted); }

    .kpis { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    @media (min-width: 768px) { .kpis { grid-template-columns: repeat(4, 1fr); } }
    .kpi { background: #0f1524; border: 1px solid var(--border); border-radius: 14px; padding: 12px; }
    .kpi .label { color: var(--muted); font-size: 12px; }
    .kpi .value { font-size: 22px; font-weight: 700; margin-top: 4px; }

    .tabs { display: flex; gap: 10px; border-bottom: 1px solid var(--border); }
    .tab { padding: 10px 12px; cursor: pointer; border: 1px solid transparent; border-radius: 10px 10px 0 0; color: var(--muted); }
    .tab.active { color: var(--text); border-color: var(--border); border-bottom-color: transparent; background: #131a2b; }

    .table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .table th, .table td { border-top: 1px solid var(--border); padding: 8px; text-align: left; }
    .table thead th { position: sticky; top: 0; background: #121827; z-index: 1; }
    .scroll { max-height: 280px; overflow: auto; border: 1px solid var(--border); border-radius: 12px; }

    .footer { margin-top: 14px; color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>
<div class="widget">
  <div class="toolbar">
    <div style="display:flex; gap:8px; align-items:center;">
      <h1 style="margin:0; font-size:18px;">Analytics Data Presentation</h1>
      <span class="footer">Paste JSON → Precheck → Render charts, KPIs & table</span>
    </div>
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button class="btn" id="renderBtn">Render</button>
      <button class="btn secondary" id="csvBtn" disabled>Download CSV</button>
      <button class="btn ghost" id="clearBtn">Clear</button>
      <button class="btn ghost" id="testsBtn" title="Run built-in tests">Run Tests</button>
    </div>
  </div>

  <div class="grid" style="margin-top:16px;">
    <div class="card">
      <div class="card-header">
        <span>Raw JSON Input</span>
        <div class="progress-row" style="flex:1;justify-content:flex-end;">
          <div class="progress" id="progress" aria-valuemin="0" aria-valuemax="100" aria-label="Rendering progress" role="progressbar">
            <div class="progress-bar" id="progressBar"></div>
          </div>
          <span class="progress-label" id="progressLabel" aria-live="polite"></span>
        </div>
      </div>
      <div class="card-body">
        <textarea id="jsonInput" class="textarea" placeholder="Paste { data: { getAnalyticsData: { data: { headers, rows }}}}"></textarea>
        <div id="precheck" class="precheck-panel" role="status" aria-live="polite"></div>
        <div id="error" class="error-panel" role="alert" aria-live="assertive"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Output</div>
      <div class="card-body">
        <div class="kpis" id="kpis"></div>

        <div style="margin-top:16px;">
          <div class="tabs">
            <div class="tab active" data-tab="state">By state</div>
            <div class="tab" data-tab="time">Over time</div>
            <div class="tab" data-tab="table">Table</div>
          </div>

          <div id="tab-state" class="tab-pane" style="padding-top:10px;">
            <canvas id="stateChart" height="220"></canvas>
          </div>
          <div id="tab-time" class="tab-pane" style="display:none; padding-top:10px;">
            <canvas id="timeChart" height="220"></canvas>
          </div>
          <div id="tab-table" class="tab-pane" style="display:none; padding-top:10px;">
            <div class="scroll"><table class="table" id="dataTable"></table></div>
          </div>
        </div>
        <div class="footer">Tip: this widget is self‑contained. You can host it as <code>analytics-embed.html</code> and embed via <code>&lt;iframe&gt;</code>.</div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  var input = document.getElementById('jsonInput');
  var renderBtn = document.getElementById('renderBtn');
  var csvBtn = document.getElementById('csvBtn');
  var clearBtn = document.getElementById('clearBtn');
  var testsBtn = document.getElementById('testsBtn');
  var errorEl = document.getElementById('error');
  var preEl = document.getElementById('precheck');
  var kpisEl = document.getElementById('kpis');
  var progress = document.getElementById('progress');
  var progressBar = document.getElementById('progressBar');
  var progressLabel = document.getElementById('progressLabel');

  var tabs = document.querySelectorAll('.tab');
  var panes = {
    state: document.getElementById('tab-state'),
    time: document.getElementById('tab-time'),
    table: document.getElementById('tab-table')
  };

  tabs.forEach(function(t){
    t.addEventListener('click', function(){
      tabs.forEach(function(x){ x.classList.remove('active'); });
      t.classList.add('active');
      var v = t.getAttribute('data-tab');
      Object.keys(panes).forEach(function(k){ panes[k].style.display = (k===v)?'block':'none'; });
    });
  });

  var rows = [];
  var headers = [];
  var stateChart, timeChart;
  var busy = false;

  function toNum(v){ var n = Number(v); return isFinite(n)?n:0; }

  // --- NEW: Precheck ---
  var REQUIRED_HEADERS = ['CMP_ELIGIBLE','CMP_SHOWN','country','countrySubdivision','date','DENY_ALL','DENY_ALL_EXPLICIT_PERCENTAGE','DENY_ALL_IMPLICIT_PERCENTAGE','DENY_ALL_RATE','DENY_ALL_TOTAL','devicetype'];

  function precheck(raw){
    var res = { ok:false, warnings:[], errors:[] };
    if(!raw || typeof raw !== 'object'){ res.errors.push('Root is not an object'); return res; }
    var g = raw.data && raw.data.getAnalyticsData;
    if(!g){ res.errors.push('Missing data.getAnalyticsData'); return res; }
    var d = g.data;
    if(!d){ res.errors.push('Missing data.getAnalyticsData.data'); return res; }
    if(!Array.isArray(d.headers)) res.errors.push('headers is not an array');
    if(!Array.isArray(d.rows)) res.errors.push('rows is not an array');
    if(res.errors.length){ return res; }

    // headers content/type
    var nonStrings = d.headers.filter(function(h){ return typeof h !== 'string'; });
    if(nonStrings.length){ res.errors.push('headers must be strings only'); }

    // required headers subset
    var missing = REQUIRED_HEADERS.filter(function(h){ return d.headers.indexOf(h)===-1; });
    if(missing.length){ res.errors.push('Missing required headers: '+missing.join(', ')); }

    // rows shape
    var H = d.headers.length;
    var badLen = d.rows.findIndex(function(r){ return !Array.isArray(r) || r.length !== H; });
    if(badLen !== -1){ res.errors.push('Row '+badLen+' length does not match headers length ('+H+')'); }

    // spot-check types for first 10 rows
    var idxDate = d.headers.indexOf('date');
    var idxShown = d.headers.indexOf('CMP_SHOWN');
    var idxElig = d.headers.indexOf('CMP_ELIGIBLE');
    var upto = Math.min(10, d.rows.length);
    for(var i=0;i<upto;i++){
      var r = d.rows[i];
      // date
      var dt = new Date(r[idxDate]);
      if(isNaN(dt.getTime())) res.warnings.push('Row '+i+': date not ISO-8601');
      // numbers
      if(isNaN(Number(r[idxShown]))) res.warnings.push('Row '+i+': CMP_SHOWN not numeric');
      if(isNaN(Number(r[idxElig]))) res.warnings.push('Row '+i+': CMP_ELIGIBLE not numeric');
    }

    res.ok = res.errors.length===0;
    return res;
  }

  function showPrecheck(res){
    if(!res){ preEl.style.display='none'; preEl.innerHTML=''; return; }
    var html = '<div class="title">Precheck</div>';
    if(res.ok){ html += '<div class="ok">✓ Structure looks good</div>'; }
    if(res.errors.length){
      html += '<div class="err">'+res.errors.length+' error(s):</div><ul>'+res.errors.map(function(e){return '<li>'+e+'</li>';}).join('')+'</ul>';
    }
    if(res.warnings.length){
      html += '<div class="warn">'+res.warnings.length+' warning(s):</div><ul>'+res.warnings.map(function(w){return '<li>'+w+'</li>';}).join('')+'</ul>';
    }
    preEl.innerHTML = html;
    preEl.style.display = 'block';
  }

  function parseJSON(raw){
    var d = raw && raw.data && raw.data.getAnalyticsData && raw.data.getAnalyticsData.data;
    if(!(d && d.headers && Array.isArray(d.rows))){
      throw new Error('Unexpected JSON shape. Expect data.getAnalyticsData.data.headers & .rows');
    }
    headers = d.headers;
    rows = d.rows.map(function(r){
      var o={}; headers.forEach(function(h,i){ o[h]=r[i]; });
      return {
        CMP_ELIGIBLE: toNum(o.CMP_ELIGIBLE),
        CMP_SHOWN: toNum(o.CMP_SHOWN),
        country: String(o.country||''),
        countrySubdivision: String(o.countrySubdivision||''),
        date: String(o.date||''),
        DENY_ALL: toNum(o.DENY_ALL),
        DENY_ALL_EXPLICIT_PERCENTAGE: toNum(o.DENY_ALL_EXPLICIT_PERCENTAGE),
        DENY_ALL_IMPLICIT_PERCENTAGE: toNum(o.DENY_ALL_IMPLICIT_PERCENTAGE),
        DENY_ALL_RATE: toNum(o.DENY_ALL_RATE),
        DENY_ALL_TOTAL: toNum(o.DENY_ALL_TOTAL),
        devicetype: String(o.devicetype||'')
      };
    });
  }

  function renderKPIs(){
    if(!rows.length){ kpisEl.innerHTML=''; return; }
    var totalShown = rows.reduce(function(a,r){ return a+r.CMP_SHOWN; },0);
    var totalEligible = rows.reduce(function(a,r){ return a+r.CMP_ELIGIBLE; },0);
    var states = (new Set(rows.map(function(r){ return r.countrySubdivision; }))).size;
    var dates = rows.map(function(r){ return new Date(r.date); }).filter(function(d){ return !isNaN(d.getTime()); }).sort(function(a,b){ return +a-+b; });
    var range = dates.length? (dates[0].toISOString().slice(0,10)+" → "+dates[dates.length-1].toISOString().slice(0,10)) : '—';
    kpisEl.innerHTML = ''+
      '<div class="kpi"><div class="label">Total CMP_SHOWN</div><div class="value">'+totalShown+'</div></div>'+
      '<div class="kpi"><div class="label">Total CMP_ELIGIBLE</div><div class="value">'+totalEligible+'</div></div>'+
      '<div class="kpi"><div class="label">States</div><div class="value">'+states+'</div></div>'+
      '<div class="kpi"><div class="label">Date range</div><div class="value" style="font-size:14px;">'+range+'</div></div>';
  }

  function groupByState(){
    var map = new Map();
    rows.forEach(function(r){ map.set(r.countrySubdivision, (map.get(r.countrySubdivision)||0)+r.CMP_SHOWN); });
    return Array.from(map.entries()).sort(function(a,b){ return b[1]-a[1]; });
  }

  function groupByDate(){
    var map = new Map();
    rows.forEach(function(r){ map.set(r.date, (map.get(r.date)||0)+r.CMP_SHOWN); });
    return Array.from(map.entries()).sort(function(a,b){ return a[0].localeCompare(b[0]); });
  }

  function renderCharts(){
    var ctx1 = document.getElementById('stateChart');
    var ctx2 = document.getElementById('timeChart');

    var s = groupByState();
    var d = groupByDate();

    if(stateChart) stateChart.destroy();
    if(timeChart) timeChart.destroy();

    stateChart = new Chart(ctx1, {
      type: 'bar',
      data: { labels: s.map(function(x){ return x[0]; }), datasets: [{ label: 'CMP_SHOWN', data: s.map(function(x){ return x[1]; }) }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision:0 } } } }
    });

    timeChart = new Chart(ctx2, {
      type: 'line',
      data: { labels: d.map(function(x){ return x[0]; }), datasets: [{ label: 'CMP_SHOWN', data: d.map(function(x){ return x[1]; }), tension: .3 }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision:0 } } } }
    });
  }

  function renderTable(){
    var tbl = document.getElementById('dataTable');
    if(!rows.length){ tbl.innerHTML = '<tbody><tr><td style="padding:12px;color:var(--muted);">No rows rendered yet. Paste JSON and click Render.</td></tr></tbody>'; return; }
    var head = '<thead><tr>'+
      '<th>CMP_ELIGIBLE</th><th>CMP_SHOWN</th><th>country</th><th>state</th><th>date</th>'+
      '<th>DENY_ALL</th><th>DENY_ALL_EXPLICIT_%</th><th>DENY_ALL_IMPLICIT_%</th>'+
      '<th>DENY_ALL_RATE</th><th>DENY_ALL_TOTAL</th><th>device</th>'+
    '</tr></thead>';
    var bodyRows = rows.map(function(r){
      return '<tr>'+
        '<td>'+r.CMP_ELIGIBLE+'</td><td>'+r.CMP_SHOWN+'</td><td>'+r.country+'</td><td>'+r.countrySubdivision+'</td><td>'+r.date+'</td>'+
        '<td>'+r.DENY_ALL+'</td><td>'+r.DENY_ALL_EXPLICIT_PERCENTAGE+'</td><td>'+r.DENY_ALL_IMPLICIT_PERCENTAGE+'</td>'+
        '<td>'+r.DENY_ALL_RATE+'</td><td>'+r.DENY_ALL_TOTAL+'</td><td>'+r.devicetype+'</td>'+
      '</tr>';
    }).join('');
    tbl.innerHTML = head + '<tbody>'+bodyRows+'</tbody>';
  }

  function toCsv(){
    if(!rows.length) return '';
    var cols = Object.keys(rows[0]);
    var header = cols.join(',');
    var body = rows.map(function(r){
      return cols.map(function(c){ return String(r[c]).replace(/"/g,'""'); })
                .map(function(v){ return /,|\n|"/.test(v)? ('"'+v+'"') : v; })
                .join(',');
    }).join('\n');
    return header + '\n' + body;
  }

  function downloadCsv(){
    var csv = toCsv();
    if(!csv) return;
    var blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url; a.download = 'analytics_'+Date.now()+'.csv'; a.click();
    URL.revokeObjectURL(url);
  }

  function setProgress(pct, label){
    progress.style.display = 'block';
    progressBar.style.width = Math.max(0, Math.min(100, pct)) + '%';
    progress.setAttribute('aria-valuenow', String(pct));
    progressLabel.textContent = label ? (pct+'% · '+label) : (pct+'%');
  }
  function resetProgress(){
    progress.style.display = 'none';
    progressBar.style.width = '0%';
    progress.removeAttribute('aria-valuenow');
    progressLabel.textContent = '';
  }
  function showError(err){
    var msg = (err && err.message) ? err.message : String(err);
    var stack = (err && err.stack) ? ('\n\nStack:\n'+err.stack) : '';
    errorEl.innerHTML = '<strong>Error:</strong> '+msg+'<pre>'+stack+'</pre>';
    errorEl.style.display = 'block';
  }
  function hideError(){ errorEl.style.display = 'none'; errorEl.textContent = ''; }
  function hidePre(){ preEl.style.display = 'none'; preEl.innerHTML = ''; }
  var tick = function(){ return new Promise(function(resolve){ setTimeout(resolve, 0); }); };

  async function handleRender(){
    if(busy) return; busy = true;
    hideError(); hidePre(); setProgress(5,'Starting');
    csvBtn.disabled = true; renderBtn.disabled = true; clearBtn.disabled = true; testsBtn.disabled = true;
    try{
      setProgress(15,'Parsing JSON'); await tick();
      if(!input.value || !input.value.trim()){
        input.value = JSON.stringify(SAMPLE, null, 2);
      }
      var parsed = JSON.parse(input.value);

      setProgress(30,'Precheck'); await tick();
      var pre = precheck(parsed);
      showPrecheck(pre);
      if(!pre.ok){ throw new Error('Precheck failed – fix the structure above and try again.'); }

      setProgress(55,'Validating & normalizing'); await tick();
      parseJSON(parsed);

      setProgress(75,'Rendering charts'); await tick();
      renderKPIs(); renderCharts();

      setProgress(90,'Rendering table'); await tick();
      renderTable();

      setProgress(100,'Done');
      csvBtn.disabled = rows.length === 0;
    }catch(e){
      rows=[]; headers=[]; csvBtn.disabled = true;
      showError(e);
      renderKPIs(); renderTable();
    } finally {
      setTimeout(function(){ resetProgress(); renderBtn.disabled = false; clearBtn.disabled = false; testsBtn.disabled = false; busy = false; }, 250);
    }
  }

  function handleClear(){ input.value=''; rows=[]; headers=[]; csvBtn.disabled=true; hideError(); hidePre(); resetProgress(); renderKPIs(); renderTable(); if(stateChart) stateChart.destroy(); if(timeChart) timeChart.destroy(); }

  function runTests(){
    var results = [];
    function assert(name, fn){
      try { fn(); results.push('✅ '+name); }
      catch(err){ results.push('❌ '+name+': '+(err && err.message ? err.message : err)); }
    }

    // Existing tests
    assert('SAMPLE parses', function(){ parseJSON(SAMPLE); if(!(rows && rows.length>0)) throw new Error('No rows from SAMPLE'); });
    assert('Invalid shape throws', function(){ var threw=false; try{ parseJSON({}); }catch(e){ threw=true; } if(!threw) throw new Error('Expected error not thrown'); });
    assert('CSV generation', function(){ var csv = toCsv(); if(!(csv.indexOf('CMP_SHOWN')>-1 && /\n/.test(csv))) throw new Error('CSV missing expected content'); });
    assert('Clear resets UI', function(){ handleClear(); if(errorEl.style.display !== 'none') throw new Error('Error panel still visible'); if(!csvBtn.disabled) throw new Error('CSV button should be disabled'); });
    assert('SAMPLE defined', function(){ if(typeof SAMPLE !== 'object' || SAMPLE === null) throw new Error('SAMPLE is not an object'); });
    assert('Bad JSON parse error', function(){ var threw=false; try{ JSON.parse('{'); }catch(e){ threw=true; } if(!threw) throw new Error('JSON.parse did not throw for invalid JSON'); });

    // New tests for precheck
    assert('Precheck passes on SAMPLE', function(){ var res = precheck(SAMPLE); if(!(res && res.ok)) throw new Error('Precheck did not pass on SAMPLE'); });
    assert('Precheck catches header mismatch', function(){ var bad = JSON.parse(JSON.stringify(SAMPLE)); bad.data.getAnalyticsData.data.rows[0].pop(); var res = precheck(bad); if(!(res && res.errors.length)) throw new Error('Expected precheck errors for row/header mismatch'); });

    console.log('\nTest results:\n'+results.join('\n'));
    errorEl.style.display='block';
    errorEl.innerHTML = '<strong>Test results</strong><pre>'+results.join('\n')+'</pre>';
  }

  renderBtn.addEventListener('click', handleRender);
  csvBtn.addEventListener('click', downloadCsv);
  clearBtn.addEventListener('click', handleClear);
  testsBtn.addEventListener('click', runTests);

  // -------------------- Sample data (must be defined BEFORE seeding) --------------------
  function sample(){ return {
    data: { getAnalyticsData: { meta: { total: 0 }, data: { headers: [
      'CMP_ELIGIBLE','CMP_SHOWN','country','countrySubdivision','date','DENY_ALL','DENY_ALL_EXPLICIT_PERCENTAGE','DENY_ALL_IMPLICIT_PERCENTAGE','DENY_ALL_RATE','DENY_ALL_TOTAL','devicetype'
    ], rows: [
      ['0','20','US','GA','2025-10-24','0','0','0','0','0','Desktop'],
      ['0','8','US','VA','2025-10-24','0','0','0','0','0','Desktop'],
      ['0','2','US','CA','2025-10-27','0','0','0','0','0','Desktop'],
      ['0','2','US','CO','2025-10-25','0','0','0','0','0','Desktop'],
      ['0','2','US','TX','2025-10-25','0','0','0','0','0','Desktop'],
      ['12','2','US','ID','2025-10-25','0','0','0','0','0','Desktop']
    ] } } }
  }; // define before use
  var SAMPLE = sample();
  // -------------------------------------------------------------------------------------

  // Seed with sample to show structure
  input.value = JSON.stringify(SAMPLE, null, 2);
  // Auto-render once
  handleRender();
})();
</script>
</body>
</html>
